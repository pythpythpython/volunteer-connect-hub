# VolunteerConnect Hub - Automated UX Testing
# =============================================
# Periodic testing to ensure all pages and features work correctly
# Powered by UX Testing AGI Board

name: UX Testing

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  push:
    branches: [main]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '_layouts/**'
  workflow_dispatch:
    inputs:
      full_test:
        description: 'Run full test suite'
        required: false
        default: 'true'

jobs:
  link-check:
    name: Check All Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Build site
        run: |
          bundle install
          bundle exec jekyll build
      
      - name: Check links
        uses: lycheeverse/lychee-action@v1
        with:
          args: >
            --verbose
            --no-progress
            --exclude-all-private
            --exclude "localhost"
            --exclude "127.0.0.1"
            --accept 200,204,301,302,403,429
            ./_site/**/*.html
          fail: true
        continue-on-error: true

  html-validation:
    name: Validate HTML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Build site
        run: |
          bundle install
          bundle exec jekyll build
      
      - name: Check HTML
        run: |
          echo "Checking HTML files for common issues..."
          
          # Check for empty href attributes
          echo "Checking for empty links..."
          grep -r 'href=""' _site/*.html || echo "✅ No empty hrefs found"
          
          # Check for broken relative links
          echo "Checking for potentially broken links..."
          for file in _site/*.html; do
            echo "Checking $file"
          done
          
          echo "✅ HTML validation complete"

  page-existence:
    name: Verify All Pages Exist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Build site
        run: |
          bundle install
          bundle exec jekyll build
      
      - name: Check required pages
        run: |
          echo "Checking required pages exist..."
          
          REQUIRED_PAGES=(
            "_site/index.html"
            "_site/opportunities.html"
            "_site/schedule.html"
            "_site/tracking.html"
            "_site/ai-assistant.html"
            "_site/docs/index.html"
          )
          
          MISSING=0
          for page in "${REQUIRED_PAGES[@]}"; do
            if [ -f "$page" ]; then
              echo "✅ $page exists"
            else
              echo "❌ MISSING: $page"
              MISSING=$((MISSING + 1))
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "::error::$MISSING required pages are missing!"
            exit 1
          fi
          
          echo "✅ All required pages exist"

  content-integrity:
    name: Check Content Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check for fake content
        run: |
          echo "Checking for potentially fabricated content..."
          
          # Check for suspicious testimonial patterns
          echo "Checking testimonials..."
          FAKE_TESTIMONIAL_PATTERNS=(
            '"[A-Z][a-z]+ [A-Z]\."' # Pattern like "Sarah M."
            'High School Student'
            'Family Volunteers'
            'Nonprofit Director'
          )
          
          ISSUES=0
          for pattern in "${FAKE_TESTIMONIAL_PATTERNS[@]}"; do
            if grep -r "$pattern" *.html 2>/dev/null; then
              echo "⚠️  Potential fake testimonial pattern found: $pattern"
              ISSUES=$((ISSUES + 1))
            fi
          done
          
          # Check for hardcoded fake statistics
          echo "Checking statistics..."
          if grep -E '[0-9]+,[0-9]+.*Active Volunteers' *.html 2>/dev/null; then
            echo "⚠️  Hardcoded user count found"
            ISSUES=$((ISSUES + 1))
          fi
          
          if grep -E '[0-9]+,[0-9]+.*Hours Contributed' *.html 2>/dev/null; then
            echo "⚠️  Hardcoded hours count found"
            ISSUES=$((ISSUES + 1))
          fi
          
          if [ $ISSUES -gt 0 ]; then
            echo "::warning::$ISSUES content integrity issues found"
          else
            echo "✅ No fake content patterns detected"
          fi

  auth-ui-test:
    name: Test Auth UI Elements
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check auth elements exist
        run: |
          echo "Checking auth UI elements..."
          
          # Check default layout has auth elements
          if grep -q 'id="loginBtn"' _layouts/default.html; then
            echo "✅ Login button exists"
          else
            echo "❌ Login button missing"
            exit 1
          fi
          
          if grep -q 'id="userMenu"' _layouts/default.html; then
            echo "✅ User menu exists"
          else
            echo "❌ User menu missing"
            exit 1
          fi
          
          # Check auth.js handles state properly
          if grep -q 'auth-show-logged-in' assets/js/auth.js; then
            echo "✅ Auth state management found"
          else
            echo "⚠️  Auth state management may be incomplete"
          fi
          
          echo "✅ Auth UI elements check complete"

  create-issue-on-failure:
    name: Create Issue on Test Failure
    runs-on: ubuntu-latest
    needs: [link-check, html-validation, page-existence, content-integrity, auth-ui-test]
    if: failure()
    steps:
      - uses: actions/checkout@v4
      
      - name: Create GitHub Issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: '[UX Testing] Automated test failure - ${{ github.run_id }}'
          content-filepath: .github/ISSUE_TEMPLATE/ux-failure.md
          labels: bug, ux-testing, automated
        continue-on-error: true
